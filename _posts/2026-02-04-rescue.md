---
layout: post
title: WordPress Rescue
subtitle: How i rescued a WordPress website from a failing SSD.
gh-badge: [star, fork, follow]
tags: [data recovery]
comments: true
mathjax: true
author: Meagan Truglio
share-img: https://mltydesigns.com/assets/img/WordPress-rescue-SSD.jpeg
share-description: "How i rescued a WordPress website from a failing SSD."
---

Sometimes things break and daily backups still aren't enough to avoid hours of labor rebuilding a hard day's work. This is where data recovery skills can save hours of wasted time. I recently had the misfortune of finding myself in exactly this situation. The SSD in a Linux machine started to fail to boot randomly and soon after stopped booting entirely, in the middle of my daily backup window. So fristrating!

This is something that can ruin your days fast, but don't panic; my pain is your potential gain. I hope this post helps someone else get through this scenario. 

## tl;dr

This is a guide to recover/migrate a MariaDB database from a damaged SSD drive that wouldn't boot using the Linux CLI.

### USB Setup and Drive Prep

First remove the drive from the computer and install it into a USB case. Make sure the cable is good and plug it into a Linux machine.

***Note: Some sysadmins disable USB storage to harden the system. Follow the steps below to ensure USB is available on your Linux machine before proceeding.***

```bash
lsblk
```

Locate the USB drive in the output and make sure that is has a mount.

```bash
Filesystem           Size  Used Avail Use% Mounted on
/dev/sdb2            116G   18G   93G  16% 
```

Enable USB Storage by editing `/etc/modprobe.d/usb-storage.conf` and commenting the lines below:

```bash
#install usb_storage /bin/true
#blacklist usb_storage
```

Reboot the machine:

```bash
sudo reboot -h now
```

If the drive is listed but isn't mounted, create a mount point:

```bash
sudo mkdir /mnt/usb
```

Then mount the drive:

```bash
sudo mount /dev/sdb2 /mnt/usb
```

You should now be able to read the USB drive at `/mnt/usb`

```bash
ls /mnt/usb

drwxr-xr-x  23 root root       4096 Jan  3 13:35 .
drwxr-xr-x   4 root root       4096 Feb  1 12:07 ..
drwxr-xr-x   4 root root       4096 Jan  3 14:20 home
```

### Make a Quick Backup Copy

If the drive is unreliable and cutting power at times, you should make a local copy to avoid issues when interacting with the database files. 

```bash
sudo cp -r /mnt/usb/var/lib/mysql /home/user_name
```

### Setup Temporary MariaDB Configuration

In order to read the database files from the failed drive we need a database engine up and running locally. This guide does not cover installing MariaDB, but will show you how to setup a temporary configuration that reads from the backup copy we took off the failed drive. 

First Stop the MariaDB server:

```bash
sudo systemctl stop mariadb
```

Delete everything inside `/var/lib/mysql` but keep the folder on new machine:

```bash
sudo rm -r /var/lib/mysql/*
```

Copy the files into the mysql data:

```bash
sudo cp -R /home/user_name/database_name /var/lib/mysql
```

Update file permissions so the mysql user can read them:

```bash
sudo chown -R mysql:mysql /var/lib/mysql/database_name
```

Startup the MariaDB server:

```bash
sudo systemctl start mariadb
```

The database should now be available in MariaDB and `phpmyadmin`. Run a database dump to get backup `.sql` archive file.

```bash
sudo mariadb-dump -u username -p wordpress > /home/username/wordpress.sql
```

### Copy Files for WordPress Website

This step only applies if the database was for WordPress. You will also need to files from the USB drive in order to full recover the website. 

Make sure the target directory is empty:

```bash
sudo rm -r /var/www/html/*
```

Copy over the files:

```bash
sudo cp -r /mnt/usb/var/www/html/* /home/username/html
```

### Cleanup

Now that we have everything we need from the USB drive, we can unmount and delete the mount point.

```bash
sudo umount /dev/sdb2
sudo rm -r /mnt/usb
```

Disable USB Storage by editing `/etc/modprobe.d/usb-storage.conf` and uncommenting the lines below:

```bash
install usb_storage /bin/true
blacklist usb_storage
```

Unplug the USB drive and Reboot the machine:

```bash
sudo reboot -h now
```

With the data safely copied off the SSD further evaulation is needed to determine if the drive is dead or can be repaired. I will be keeping this drive to work on further when i have extra time. 

[WordPress Rescue SSD](https://mltydesigns.com/assets/img/WordPress-rescue-SSD.jpeg)
